[Туториал от Unity по оптимизации свет](https://learn.unity.com/tutorial/introduction-to-the-project?uv=2019.4&projectId=60d11a5cedbc2a18f70e4d61#60d12580edbc2a36bd9d0a69)
[Сцена из туториала](https://assetstore.unity.com/packages/essentials/tutorial-projects/lighting-optimisation-tutorial-73563)
[Light prode Youtube](https://www.youtube.com/watch?v=SJrm5C7aJdg&ab_channel=aboutgamemaking)
[Light Prode NightTrainCode](https://www.youtube.com/watch?v=6DcwI-7e-7k&ab_channel=NightTrainCode)
[Работа с освещением в Unity — теория и практика](https://habr.com/ru/post/266839/)
[[DrawCall]]
[[Realtime Global Illumination]]
[[LightMAps]]
[[Lightmap Parameters Asset]]

## Нормальный размер lightMap 
![[Pasted image 20230210210120.png]]
![[Pasted image 20230210210156.png]]

## Очистка GI Cahs
![[Pasted image 20230210133903.png]]
## Selecting Indirect Resolution values
Параметр indeirect Resolution определение единиц измерения проекта 1- 1метр.
Часто косвенное разрешение вашей сцены можно определить исходя из масштаба вашего игрового мира. Например, ваша сцена представляет собой небольшую, но многолюдную внутреннюю среду с большим разнообразием отраженного освещения? В этом случае может быть оправдано более высокое разрешение карты освещения, такое как 2-3 текселя на единицу, чтобы захватить это более детальное или «высокочастотное» освещение.

Возможно, ваша сцена — это большая открытая среда, где масштабы мира значительно больше. У вас могут быть поверхности площадью в сотни или даже тысячи единиц с небольшим изменением цвета отраженного света. В таких случаях разрешение, подходящее для захвата сложных деталей освещения, присутствующих в сцене внутри помещения, было бы расточительным, когда оно применялось бы на больших и менее характерных пространствах наружной среды. Мы бы потратили впустую ценное процессорное время и доступную память, если бы нам приходилось хранить и обновлять тексели карт освещения, которые мало влияют на общий вид сцены. Что еще более важно, для целей этого урока мы будем увеличивать количество текселей карты освещения, которые необходимо учитывать во время предварительного расчета освещения. Это может иметь огромное влияние на время предварительных вычислений.

В случае внешней среды подходящее разрешение карты освещения может составлять где-то между 0,5–1 текселей на единицу для больших объектов в сцене или 0,1–0,5 текселей для ландшафта.

Предполагая, что вы работаете со сценой в человеческом масштабе с размером единицы 1 единица = 1 метр, более подходящими значениями являются:

-   Сцены в помещении: от 2 до 3 текселей на единицу
-   Наружные сцены: от 0,5 до 1 текселя на единицу
-   Сцены местности: от 0,1 до 0,5 текселей на единицу
![[Pasted image 20230210123225.png]]



## Introduction to Charts

В Precomputed Realtime GI Unity Chart — это область текстуры карты освещения, на которую вы наносите UV карты освещения данного объекта сцены. Вы можете думать об этом как о небольшой плитке, содержащей изображение освещения, воздействующего на этот объект. Диаграмма состоит из двух частей: освещенности (освещения) и направленности (кодирования доминирующего направления света).
При создании Precomputed Realtime GI освещение рассчитывается для каждого тексела, включенного в диаграмму. Большое количество диаграмм в сцене может быть одним из самых больших недостатков времени предварительного вычисления, поэтому важно понимать, как работают диаграммы и как вы можете управлять ими, чтобы оптимизировать время предварительного вычисления освещения.
![[Pasted image 20230210124431.png]]

## Introduction to placing Light Probes
Зондовое освещение — это быстрый метод аппроксимации освещения в приложениях рендеринга в реальном времени, таких как игры. Он обычно используется для освещения персонажей и других нестатических (динамических) объектов в игровом мире. Освещение зонда очень эффективно во время выполнения и имеет дополнительное преимущество, заключающееся в быстром предварительном вычислении.
Хотя в целом было полезно установить для GameObjects в группе Environment значение Static, чтобы начать настройку освещения, в этом родительском объекте есть много объектов, которые вместо этого могли бы стать хорошими кандидатами на пробное освещение. Снятие флагов Static для этих объектов будет означать, что они больше не учитываются системой Unity Precomputed Realtime GI, и поэтому количество диаграмм карты освещения будет уменьшено. Помните: сокращение количества диаграмм в сцене является ключом к сокращению времени предварительного вычисления. Небольшие выпуклые объекты мусора, например, идеально подходят для освещения зонда.
Если вы просмотрите объекты, отнесенные к категории реквизита, вы обнаружите, что многие из них представляют собой небольшие объекты в стиле обломков и «украшения» сцены, такие как камни, ведра и деревянные доски. Этих объектов много, и многие из этих относительно небольших объектов было бы сложно развернуть. Получение карты освещения без искажений, скорее всего, приведет к большому количеству UV-оболочек . Большее количество UV-оболочек требует дополнительных диаграмм, большее количество диаграмм означает, что нужно вычислить больше текселей карты освещения и так далее.

Нестатические объекты получают освещение в зависимости от близости к ближайшим зондам. Решение о том, какой зонд может «считывать» объект, принимается путем разделения пространства между Световыми зондами на тетраэдрические объемы и последующей проверки того, в какой тетраэдр попадает данный объект. Следовательно, для создания этих тетраэдров зонды должны быть расположены так, чтобы они создавали трехмерный объем или клетку.

Освещение зонда относительно недорого во время выполнения и быстро вычисляется. Тем не менее, чтобы максимизировать производительность, необходимо соблюдать осторожность при размещении датчиков. Несмотря на более быструю настройку, расположение световых зондов с плотной сеткой потенциально расточительно, поскольку многие из этих зондов не будут производить выборку большого количества вариаций в местных условиях освещения. Для повышения эффективности рекомендуется размещать датчики с большей плотностью вокруг областей, где наблюдается ярко выраженное изменение освещения . Это может включать в себя области, где есть переход от света к тени, например, или, возможно, где могут быть сильные цвета, созданные отражением света.

Приступим к настройке и размещению Light Probes в сцене:

1. Создайте группу Light Probe из меню GameObject (Верхнее меню: GameObject > Light > Light Probe Group ). Теперь можно приступать к размещению зондов.

2. В Иерархии выберите только что созданную группу Light Probe.

3. В Инспекторе выберите Edit Light Probes в компоненте Light Probe Group.

![](https://connect-prd-cdn.unity.com/20210707/learn/images/2c5f1d0e-f10c-42a0-ab18-cb36a9697309_LightOpt_3.6.3_EditLightProbes.png)

Выберите изображение, которое надо развернуть

4. Вы можете выбрать сами датчики в представлении «Сцена». Удалите все, кроме одного, угловые датчики из создаваемого расположения куба по умолчанию.

5. Расположите оставшийся зонд так, чтобы он находился чуть выше Terrain в окружающей среде, а затем продублируйте его, нажав Ctrl + D ( Cmd + D в macOS).

6. С помощью инструмента «Перемещение» ( W ) переместите этот второй датчик вверх по оси Y, чтобы он был примерно на 2 метра выше первого.

7. Теперь снова продублируйте зонд и переместите новую копию намного выше, возможно, еще на 5 метров вверх по оси Y.

Причина создания такого вертикального расположения заключается в том, чтобы вы могли сэмплировать непрямой свет, отраженный от земли, с высоты головы, а также в воздухе (возможно, что объекты могут оторваться от земли). Когда вы копируете эти Light Probes по сцене для создания объемов, вам необходимо убедиться, что объекты в любом месте игровой области попадут в один из тетраэдров, созданных между Probes. Эти объемы визуализируются в виде пурпурных линий, проведенных между датчиками.
![[Pasted image 20230210132305.png]]

## Вкладка — Baked GI

  

-   **Baked Resolution**. Этот параметр можно считать общим качеством “лайтмапа”, он же — Diffuse, о чём я говорил в прошлом абзаце. Чем выше вы его ставите, тем чётче будет картинка. Но сильно не увлекайтесь, есть определённый лимит, после которого вы не заметите никакой разницы. Вообще тут важно искать баланс между качеством “запечки” и временем рендера.
-   **Baked Padding**. Расстояние между отдельными текстурками на общем атласе. Нужно для того, чтобы при компрессии, когда атлас начинает “плыть”, цвет одной отдельной текстурки не заляпал другую текстурку. Для своей игры я обычно ставлю в пределах 1-3.
-   **Compressed**. Практически всегда у вас здесь будет выставлена галочка, при этом Unity будет сжимать “лайтмап”-атласы. В несжатом состоянии они “весят” неприлично много.
-   **Indirect Resolution**. Этот параметр можно считать качеством, или детализацией, слоёв GI, FG и, возможно, AO. Нет смысла здесь ставить большое число, разницы вы не увидите. Например, если в Baked Resolution вы поставите 40, то в Indirect можно спокойно поставить в районе 3-8.
-   **Ambient Occlusion**. Как я уже писал в самом начале статьи, AO — это затенение в разного рода углах и трещинах вследствие потери энергии лучом света. Этот параметр настраивает, насколько быстро теряется энергия. Чем выше параметр, тем темнее будет AO. Напомню, что АО — это художественный приём, на самом деле не имеющий ничего общего с физически корректным освещением.
-   **Max Distance**. По большому счёту, это просто дистанция затемнения для Ambient Occlusion. Если взять в пример угол комнаты, то при высоком Max Distance затемнение будет начинаться очень рано, а при низком Max Distance затемнение будет только в самой-самой глубине угла.
-   **Final Gather**. Включает описанный в начале статьи метод отражённого света. По умолчанию рендерится только GI, здесь же вы включаете и FG. Нигде нет настроек количества точек, которое FG раскидывает по сцене. Предполагаю, что это так или иначе зависит от Indirect Resolution.
-   **Ray Count**. Количество лучей, которые испускает каждая точка FG. Скорее всего, вам за глаза будет хватать 32 или 64 луча.

  

## Вкладка — General GI

  
Давайте пройдёмся по интересующим нас настройкам во вкладке General GI:  
  

-   **Directional Mode**. Весьма специфичный параметр, “запекающий” для каждого “лайтмапа” второй атлас. Обычный “лайтмап” представляет из себя простую текстуру, которая затем накладывается поверх ваших объектов, имитируя их освещённость. Второй же атлас, называемый Directional, содержит в себе информацию о направлении движения лучей света. Этот режим имеет смысл включать только если вы используете normal map’ы и работаете не над мобильной игрой. В противном случае рекомендуется брать Non Directional.
-   **Indirect Intensity**. Можно сказать, что это яркость слоёв с непрямым светом, в частности FG. Ранее я уже рассказывал, что на самом деле “лайтмап” собирается из слоёв, накладываемых поверх друг дружки.
-   **Bounce Boost**. Настраивает яркость отражённых фотонов, информация о которых содержится в слое с GI.
-   **Atlas Size**. Тут указывается размер текстурных атласов с “запечённым” освещением. Если вы делаете игру для мобильных устройств прямиком из 19-го века, то есть смысл выставлять здесь 1024, так как текстуры размером в 2048 не поддерживаются очень старыми устройствами. В противном случае я рекомендую ставить 2048, его поддерживают практически все устройства последних лет. Как вы понимаете, чем меньше размер одного атласа, тем больше придётся их делать. Если вы знакомы с термином Draw Call, то вам не составит труда предугадать, что увеличение количества атласов нанесёт удар по производительности. Поэтому если у вас нет специфичных требований, старайтесь рендерить в 2048.